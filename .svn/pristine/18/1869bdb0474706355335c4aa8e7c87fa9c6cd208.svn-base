$(function () {
    var httpUrl="http://www.wxlovezy.top:8080/spring";
    var currentPage = 1;
    var queryStr="";
    var pageSize = 5;
    var brandId;
    var carId;
    var $pagenums;
    var totalPage = 0;
    (function(){
        $.ajax({
            async:false,
            type:"GET",
            url:httpUrl+"/carBrand/getList/",
            success:function(data){
                $('.carbrands select').append("<option value='0'>全部</option>");

                $.each(data.data,function(i,v){
                    $('.carbrands select').append("<option value='"+v.id+"'>"+v.brandName+"</option>");
                });
                $('.cars select').append("<option value='0'>全部</option>");
            }
        });
    })();

    $('.carbrands select').change(function(){
        brandId= $('.carbrands select').find('option:selected').val();
        queryCarNav(brandId);
    });

    function queryCarNav(brandId) {
        $('.cars select').children().remove();
        if(brandId==0){
            $('.cars select').append("<option value='0'>全部</option>");
        }else{
            $.ajax({
                type:"GET",
                dataType:"json",
                url:httpUrl+"/adminCar/getCarListByBrandId/"+brandId,
                success:function (res) {
                    if(res.success==false){
                        $('.cars select').append("<option value='none'>无</option>");
                    }else{
                        $.each(res.data,function(i,v){
                            $('.cars select').append("<option value='"+v.id+"'>"+v.carName+"</option>");
                        });
                    }
                }
            })
        }

    }

    brandId= $('.carbrands select').find('option:selected').val();
    carId= $('.cars select').find('option:selected').val();
    queryBriefCount(queryStr,brandId,carId);
    getBriefList(queryStr,brandId,carId,currentPage,pageSize);

    function GetRequest() {
        var url = location.search; //获取url中"?"符后的字串
        var theRequest = new Object();
        if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            strs = str.split("&");
            for(var i = 0; i < strs.length; i ++) {
                theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);
            }
        }
        return theRequest;
    }

    var isback = GetRequest().isBack;
    if(isback == "true"){
        brandId = GetRequest().brandId;
        carId = GetRequest().carId;
        $(".carbrands select option[value='"+brandId+"']").attr("selected","selected");
        queryCarNav(GetRequest().brandId);
        $(".cars select option[value='"+carId+"']").attr("selected","selected");
        queryBriefCount(queryStr,brandId,carId);
        getBriefList(queryStr,brandId,carId,GetRequest().currentPage,pageSize);
        $('.currentPage').html(GetRequest().currentPage);

    }

    function getBriefList(queryStr,brandId,carId,currentPage,pageSize) {
        var url;
        if(queryStr==""){
            url = httpUrl+"/adminCarSeries/getBriefList/"+brandId+"/"+carId+"/"+currentPage+"/"+pageSize;
        }else{
            url = httpUrl+"/adminCarSeries/queryBriefList/"+queryStr+"/"+currentPage+"/"+pageSize+"";
        }

        var $carsseries = $('#carsSerirsLists');
        if($carsseries.children().length!=0){
            $carsseries.children().remove();
        }
        $.ajax({
            type:"GET",
            url:url,
            dataType:"json",
            async:false,
            success:function (res) {
                $.each(res.data,function(i,v){
                    var issale = v.isSale==1?"在售":v.isSale==2?"未售":"停售"
                    $carsseries.append(
                        "<tr data-id="+v.id+">"+
                        "<td class='cs_1' title='"+v.seriesName+"'>"+v.seriesName+"</td>"+
                        "<td class='cs_2' title='"+v.price+"'>"+v.price+"</td>"+
                        "<td class='cs_3' title='"+issale+"'>"+issale+"</td>"+
                        "<td class='cs_4' title='"+v.yearType+"'>"+v.yearType+"</td>"+
                        "<td class='cs_5'><div class='btn'><a href='#' class='delete'>删除</a><a href='#' class='detail'>详情</a><a href='#' class='photo'>图片</a></div></td>"+
                        "</tr>"
                    );
                })
            }
        })
        var $trs = $carsseries.children();
        if($trs.length!=0){
            $.each($trs,function(i,v){
                var dataid = $(this).attr('data-id');
                var $options = $(this).find('a');
                $.each($options,function(){
                    $(this).click(function(){
                        if($(this).attr('class')=="delete"){
                            if(confirm("确定删除？")){
                                deleteCarSeries(dataid);
                            }
                        }else if($(this).attr('class')=="detail"){
                            var oldPage = $('.currentPage').text();
                            window.location.href="carseriespublish.html?id="+dataid+"&brandId="+brandId+"&carId="+carId+"&currentPage="+oldPage;
                            //把当前页面带过去
                        }
                    })
                })
            })
        }
    }
    function queryBriefCount(queryStr,brandId,carId) {
        var url;
        if(queryStr==""){
            url = httpUrl+"/adminCarSeries/getBriefNum/"+brandId+"/"+carId;
        }else{
            url = httpUrl+"/adminCarSeries/queryBriefNum/"+queryStr;
        }
        //上一次的页码 如果存在就清除掉
        var $oldpagenum = $('.pagenumb');
        if($oldpagenum.length!=0){
            $oldpagenum.remove();
        }
        $.ajax({
            type:"GET",
            dataType:"json",
            timeout:10000,
            async:false,
            url:url,
            success:function(res){
                //页码
                $('.totalNews').html(res.data);
            }
        });
        var totalNews = $('.totalNews').text();
        $('.pageSize').html(pageSize);
        totalPage = Math.ceil(totalNews/pageSize);
        $('.totalPages').text(totalPage);

        for(var i = 1;i<=totalPage;i++) {
            $('.pagenext').before("<a href='#' class='pagenumb'>" + i + "</a>");
        }
        $pagenums = $('.pagenumb');
    }

    function deleteCarSeries(id) {
        var page = $('.currentPage').html();
        if(id=="" || id==null){
            return;
        }else{
            $.ajax({
                type:"GET",
                url:httpUrl+"/adminCarSeries/delete/"+id,
                dataType:"json",
                success:function(data){
                    alert(data.mess);
                    //刷新页面
                    getBriefList(queryStr,brandId,carId,currentPage,pageSize);
                    queryBriefCount(queryStr,brandId,carId);
                }
            });
        }
    }

    $('#dosearch').click(function () {
        brandId= $('.carbrands select').find('option:selected').val();
        carId= $('.cars select').find('option:selected').val();
        queryBriefCount(queryStr,brandId,carId);
        getBriefList(queryStr,brandId,carId,currentPage,pageSize);

        $.each($pagenums,function(){
            $(this).click(function(){
                currentPage = $(this).html();
                getBriefList(queryStr,brandId,carId,currentPage,pageSize);
                $('.currentPage').html(currentPage);
            })
        })
    })

    //点击页码进行查询
        $.each($pagenums,function(){
            $(this).click(function(){
                currentPage = $(this).html();
                getBriefList(queryStr,brandId,carId,currentPage,pageSize);
                $('.currentPage').html(currentPage);
            })
        })
    //点击前后进行查询
    var $pre = $('.pagePre');
    var $next = $('.pagenext');

    $pre.click(function(){
        var page = $('.currentPage').html();
        if(page == 1){
        }else {
            page--;
            getBriefList(queryStr,brandId,carId,page,pageSize);
            $('.currentPage').html(page);
        }
    })
    $next.click(function(){
        var page = $('.currentPage').html();
        if(page == totalPage){
        }else {
            page++;
            getBriefList(queryStr,brandId,carId,page,pageSize);
            $('.currentPage').html(page);
        }
    })
    $('#searchBtn').click(function(){
        queryStr = $('#search').val();
        queryBriefCount(queryStr,brandId,carId);
        getBriefList(queryStr,brandId,carId,currentPage,pageSize);
        $.each($pagenums,function(){
            $(this).click(function(){
                currentPage = $(this).html();
                getBriefList(queryStr,brandId,carId,currentPage,pageSize);
                $('.currentPage').html(currentPage);
            })
        })
    });

    $('#search').keydown(function () {
        if(event.keyCode== "13"){
            var queryStr = $('#search').val();
            queryBriefCount(queryStr,brandId,carId);
            getBriefList(queryStr,brandId,carId,currentPage,pageSize);
            $.each($pagenums,function(){
                $(this).click(function(){
                    currentPage = $(this).html();
                    getBriefList(queryStr,brandId,carId,currentPage,pageSize);
                    $('.currentPage').html(currentPage);
                })
            })
        }
    })
    
    $('#publishNew').click(function () {
        brandId= $('.carbrands select').find('option:selected').val();
        carId= $('.cars select').find('option:selected').val();
        var oldPage = $('.currentPage').text();
        if(carId=="none"){
            alert("请先添加该品牌对应的车系，才可继续添加车辆")
        }else{
            window.location.href="carseriespublish.html?brandId="+brandId+"&carId="+carId+"&currentPage="+oldPage;
        }
    })
})